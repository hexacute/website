<!DOCTYPE html><html ><head><title data-react-helmet="true">Les Dockerfiles | Putain de code</title><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" name="description" value="Blog participatif de la communauté dev"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="Putain de code !" property="og:site_name"/><meta data-react-helmet="true" content="@putaindecode" name="twitter:site"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><meta data-react-helmet="true" content="Les Dockerfiles | Putain de code" property="og:title"/><meta data-react-helmet="true" content="Les Dockerfiles | Putain de code" name="twitter:title"/><link data-react-helmet="true" title="RSS Feed" href="/api/articles/feeds/desc/feed.xml" rel="alternate" type="application/rss+xml"/><link data-react-helmet="true" href="/favicon.ico" rel="shortcut icon"/><link data-react-helmet="true" href="https://putaindecode.io/articles/les-dockerfiles" rel="canonical"/><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion-rpcss="cv6q29 cqg32g vfl2jy 94ols9 1plrth7 1qdfdal">@-webkit-keyframes animation-cv6q29{0%{opacity:0;-webkit-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}@keyframes animation-cv6q29{0%{opacity:0;-webkit-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}body{padding:0;margin:0;background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}@media (prefers-color-scheme:dark){body{background-color:#222;}}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}html{color:#46515B;font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}@media (prefers-color-scheme:dark){html{color:#ddd;}}a{color:#CC0613;-webkit-text-decoration:underline;text-decoration:underline;}@media (prefers-color-scheme:dark){a{color:#F87098;}}a:hover{-webkit-text-decoration:none;text-decoration:none;}*,*:before,*:after{box-sizing:border-box;}</style><style data-emotion-rpcss="u6xx5u">.rpcss-u6xx5u{background-color:#000;padding:10px;color:#fff;text-align:center;}</style><div class="rpcss-u6xx5u"><style data-emotion-rpcss="fyih5c">.rpcss-fyih5c{font-size:24px;font-weight:700;}</style><div class="rpcss-fyih5c" role="heading">Black Lives Matter</div><div><style data-emotion-rpcss="th8dfi">.rpcss-th8dfi{font-size:20px;color:#8CBEF9;}</style><a class="rpcss-th8dfi" href="https://blacklivesmatters.carrd.co/#">Comment aider</a> • <a class="rpcss-th8dfi" href="https://minnesotafreedomfund.org">Minnesota Freedom Fund</a> • <a class="rpcss-th8dfi" href="https://www.okpal.com/adama-traore/#/">Justice Pour Adama</a></div></div><style data-emotion-rpcss="1s4nnc7">.rpcss-1s4nnc7{background-color:#CC0613;background-image:linear-gradient(135deg,#E51D58 0%,#CC0613 100%);}</style><header class="rpcss-1s4nnc7" style="background-image:linear-gradient(to bottom right, hsl(83, 100%, 35%), hsl(69, 100%, 30%))"><style data-emotion-rpcss="qx7dny">.rpcss-qx7dny{width:100%;max-width:1024px;margin:0 auto;padding:0 10px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-qx7dny"><style data-emotion-rpcss="7s9om2">.rpcss-7s9om2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:20px 0 50px;}</style><div class="rpcss-7s9om2"><style data-emotion-rpcss="gdpa5c">.rpcss-gdpa5c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-gdpa5c" href="/"><style data-emotion-rpcss="1lm4738">.rpcss-1lm4738{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;padding-bottom:10px;}</style><div class="rpcss-1lm4738"><style data-emotion-rpcss="13o7eu2">.rpcss-13o7eu2{display:block;}</style><svg class="rpcss-13o7eu2" height="36px" width="36px" viewBox="0 0 36 36"><defs><linearGradient id="PutainDeCodeLogoGradient" x1="50%" x2="50%" y1="0%" y2="127.223881%"><stop offset="0%" stop-color="#E41D57"></stop><stop offset="100%" stop-color="#C60000"></stop></linearGradient></defs><circle cx="18" cy="18" fill="url(#PutainDeCodeLogoGradient)" r="17" stroke="#FFFFFF" stroke-width="2"></circle><polygon fill="#FFFFFF" points="15.9033203 18.2246094 15.9033203 18.3710938 11.2304688 20.5317383 11.2304688 22.8095703 18.0566406 19.184082 18.0566406 17.4116211 11.2304688 13.7788086 11.2304688 16.0639648"></polygon><rect height="14" width="2" fill="#FFFFFF" x="22" y="11"><animate attributeName="opacity" begin="100ms" calcMode="discrete" dur="2s" repeatCount="indefinite" values="1;0"></animate></rect></svg><style data-emotion-rpcss="4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion-rpcss="u5k24">.rpcss-u5k24{font-size:22px;color:#fff;font-weight:800;}</style><div aria-level="2" class="rpcss-u5k24" role="heading">Putain de code !</div></div><style data-emotion-rpcss="1nyebg4">.rpcss-1nyebg4{font-size:14px;color:rgba(255,255,255,0.8);text-align:center;}</style><div class="rpcss-1nyebg4">Blog participatif de la communauté dev</div></a></div></div></header><style data-emotion-rpcss="kcj2v3">.rpcss-kcj2v3{background-color:#F9F6F6;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}@media (prefers-color-scheme:dark){.rpcss-kcj2v3{background-color:#111;}}</style><div class="rpcss-kcj2v3"><style data-emotion-rpcss="ees1g6">.rpcss-ees1g6{-webkit-animation:animation-cv6q29 500ms ease-out 0ms 1 normal none running;animation:animation-cv6q29 500ms ease-out 0ms 1 normal none running;}</style><div class="rpcss-ees1g6"><div class="rpcss-qx7dny"><style data-emotion-rpcss="1qc2bam">.rpcss-1qc2bam{font-size:42px;font-weight:800;text-align:center;padding-top:40px;line-height:1.2;margin:0;}</style><h1 class="rpcss-1qc2bam">Les Dockerfiles</h1><style data-emotion-rpcss="4ach9y">.rpcss-4ach9y{font-size:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-top:10px;padding-bottom:40px;color:#46515B;-webkit-text-decoration:none;text-decoration:none;}@media (prefers-color-scheme:dark){.rpcss-4ach9y{color:#ccc;}}</style><a class="rpcss-4ach9y" href="https://github.com/Uhsac"><style data-emotion-rpcss="uco8i7">.rpcss-uco8i7{width:32px;height:32px;border-radius:100%;margin-right:10px;}</style><img class="rpcss-uco8i7" alt="Uhsac" src="https://avatars.githubusercontent.com/Uhsac?size=64"/><div>Uhsac<!-- --> <!-- -->•<!-- --> <time dateTime="Thu, 02 Jul 2015 00:00:00 GMT">2015/07/02</time></div></a><style data-emotion-rpcss="1ow2283">.rpcss-1ow2283{max-width:640px;width:100%;font-size:18px;margin:0 auto;line-height:1.7;}.rpcss-1ow2283 h2,.rpcss-1ow2283 h3,.rpcss-1ow2283 h4,.rpcss-1ow2283 h5,.rpcss-1ow2283 h6{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.2;}.rpcss-1ow2283 img{max-width:100%;background-color:rgba(255,255,255,0.75);}.rpcss-1ow2283 code{font-size:0.9em;font-family:PragmataPro,SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:1;background-color:#FAF3E1;margin:0 0.2em;}@media (prefers-color-scheme:dark){.rpcss-1ow2283 code{background-color:#4F3804;}}.rpcss-1ow2283 pre{padding:10px;overflow-x:auto;font-size:14px;border-radius:10px;border:2px solid rgba(0,0,0,0.1);-webkit-overflow-scrolling:touch;}@media (prefers-color-scheme:dark){.rpcss-1ow2283 pre{border:2px solid rgba(255,255,255,0.1);}}.rpcss-1ow2283 pre code{font-size:14px;background-color:transparent;margin:0;}.rpcss-1ow2283 blockquote{padding-left:20px;margin:0;font-size:16px;border-left:3px solid rgba(0,0,0,0.4);font-style:italic;}.rpcss-1ow2283 .hljs-keyword{color:#DA6BB5;}.rpcss-1ow2283 .hljs-constructor{color:#DD792B;}.rpcss-1ow2283 .hljs-identifier{color:#1E9EA7;}.rpcss-1ow2283 .hljs-module-identifier{color:#C84682;}.rpcss-1ow2283 .hljs-string{color:#3BA1C8;}.rpcss-1ow2283 .hljs-comment{color:#aaa;}.rpcss-1ow2283 .hljs-operator{color:#DA6BB5;}.rpcss-1ow2283 .hljs-attribute{color:#4CB877;}.rpcss-1ow2283 table{width:100%;text-align:center;}.rpcss-1ow2283 figure{padding:20px 0;}.rpcss-1ow2283 figcaption{text-align:center;}.rpcss-1ow2283 a{overflow-wrap:break-word;}.rpcss-1ow2283 table thead th{background-color:#E4EBEE;padding:10px 0;}</style><div class="rpcss-1ow2283"><p>Dans <a href="/fr/articles/docker/">l'article précédent</a>, je vous ai présenté le
fonctionnement de base de Docker. Mais cela vous limitait à l'usage des images
que vous pouviez trouver sur le <a href="https://registry.hub.docker.com/">Docker Hub</a>.
Afin de vraiment pouvoir utiliser Docker au maximum, il serait appréciable de
pouvoir créer des images adaptées à nos projets et c'est là l'utilité des
Dockerfiles.</p>
<h1>Les Dockerfiles</h1>
<p>Les Dockerfiles sont des fichiers qui permettent de construire une image Docker
adaptée à nos besoins, étape par étape. Rentrons dans le vif du sujet en créant
une image permettant de lancer un projet JavaScript.</p>
<p>Pour commencer, créez un nouveau fichier <code>Dockerfile</code> à la racine de votre
projet.</p>
<p>La première chose à faire dans un Dockerfile est de définir de quelle image vous
héritez. Pour cet exemple, je vous propose d'utiliser une image de Debian comme
base (ce qui est une bonne pratique, car cette image est plutôt légère en
comparaison avec celle d'Ubuntu par exemple).</p>
<pre><code>FROM debian:jessie
</code></pre>
<p><code>FROM</code> permet de définir notre image de base, vous pouvez l'utiliser seulement
une fois dans un Dockerfile.</p>
<p>Comme nous voulons créer une image pour une application JavaScript full-stack,
nous devons commencer par installer Node.js. Pour ce faire, on va télécharger
l'archive Node.js directement depuis le site officiel à l'aide de curl que nous
allons aussi devoir installer.</p>
<pre><code>RUN apt-get update \
&& apt-get install -y curl \
&& rm -rf /var/lib/apt/lists/*

RUN curl -LO "https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz" \
&& tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 \
&& rm node-v0.12.5-linux-x64.tar.gz
</code></pre>
<p><code>RUN</code> permet d'exécuter une commande à l'intérieur de votre image comme si vous
étiez devant un shell unix.</p>
<p>La première commande nous permet d'installer curl et de nettoyer ensuite le
gestionnaire de paquets afin que notre image soit un peu plus légère.</p>
<p>Avec la deuxième commande, nous téléchargeons le binaire de Node.js que nous
installons ensuite à sa place, et on n'oublie pas de supprimer l'archive
ensuite.</p>
<p>Vous pouvez vous demander pourquoi j'exécute plusieurs commandes sur une même
instruction <code>RUN</code> ? Eh bien, cela permet simplement de limiter le nombre
d'instructions dans votre Dockerfile ce qui rendra votre image finale plus
légère.</p>
<p>Maintenant, nous allons ajouter les sources de notre projet dans l'image et
télécharger nos dépendances.</p>
<pre><code>ADD package.json /app/

WORKDIR /app

RUN npm install

ADD . /app/
</code></pre>
<p><code>ADD</code> permet d'ajouter des fichiers locaux ou distants à l'intérieur de votre
image, il est le plus souvent utilisé pour importer les sources de votre projet
ou des fichiers de configuration.</p>
<p><code>WORKDIR</code> permet de changer le répertoire courant de votre image, toutes les
commandes qui suivront seront exécutées à partir de ce répertoire.</p>
<p>Avec la dernière instruction, nous ajoutons les sources de notre projet à
l'intérieur de l'image, mais vous allez vous demander pourquoi nous ne l'avons
pas fait en même temps que l'ajout des fichiers de dépendances. Eh bien, cela
nous permet d'économiser beaucoup de temps !</p>
<p>Quand Docker crée une nouvelle image à partir d'un Dockerfile, il exécute chaque
instruction dans un conteneur, et le résultat de cette instruction est
sauvegardé sous forme de couche. Au final, une image est un assemblage de
plusieurs couches (une par instruction). Et donc, quand vous reconstruisez une
image pour la seconde fois, les instructions qui n'impliquent pas de changements
ne sont pas réexécutées, car la couche est récupérée depuis l'image précédente.
Par contre, si l'instruction implique un changement quelconque, elle est
réexécutée ainsi que toutes les instructions suivantes.</p>
<p>Dans notre cas, les sources auront tendance à beaucoup changer, et donc ne pas
retélécharger les dépendances à chaque changement dans le code est un réel gain
de temps !</p>
<p>Maintenant, nous allons indiquer quel port et dossier nous souhaitons partager
avec l'extérieur du conteneur.</p>
<pre><code>EXPOSE 3000

VOLUME /app/log
</code></pre>
<p><code>EXPOSE</code> et <code>VOLUME</code> permettent respectivement d'indiquer quel port et quel
dossier nous souhaitons partager.</p>
<p>Et pour finir, nous pouvons indiquer quelle instruction doit s'exécuter au
lancement de votre conteneur grâce à l'instruction <code>CMD</code>.</p>
<pre><code>CMD node server.js
</code></pre>
<p>Voici un résumé de notre Dockerfile :</p>
<pre><code># Image de base
FROM debian:jessie

# Installation de curl avec apt-get
RUN apt-get update \
&& apt-get install -y curl \
&& rm -rf /var/lib/apt/lists/*

# Installation de Node.js à partir du site officiel
RUN curl -LO "https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz" \
&& tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 \
&& rm node-v0.12.5-linux-x64.tar.gz

# Ajout du fichier de dépendances package.json
ADD package.json /app/

# Changement du repertoire courant
WORKDIR /app

# Installation des dépendances
RUN npm install

# Ajout des sources
ADD . /app/

# On expose le port 3000
EXPOSE 3000

# On partage un dossier de log
VOLUME /app/log

# On lance le serveur quand on démarre le conteneur
CMD node server.js
</code></pre>
<p>Avant de transformer ce Dockerfile en une image, vous devez créer un fichier de
plus, le <code>.dockerignore</code>, ce fichier permet comme un <code>.gitignore</code> de ne pas
inclure certain fichiers dans votre image Docker, et c'est très important afin
d'éviter d'inclure les dépendances de votre projet dans votre image
(<code>node_modules</code> dans notre cas) qui sont propres à votre système, mais pas au
système du conteneur. Voici à quoi votre <code>.dockerignore</code> doit ressembler :</p>
<pre><code>node_modules
.git
</code></pre>
<p>Pour transformer ce Dockerfile en une image Docker, vous devez utiliser cette
commande :</p>
<pre><code class="language-console"><span class="hljs-meta">$</span><span class="bash"> docker build -t fullstack-js .</span>
Sending build context to Docker daemon 4.381 MB
Sending build context to Docker daemon
Step 0 : FROM debian:jessie
<span class="hljs-meta"> ---&gt;</span><span class="bash"> bf84c1d84a8f</span>
Step 1 : RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; rm -rf /var/lib/apt/lists/*
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 93258459a279</span>
...
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 4fffcf3749a2</span>
Removing intermediate container 93258459a279
Step 2 : RUN curl -LO &quot;https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz&quot; &amp;&amp; tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 &amp;&amp; rm node-v0.12.5-linux-x64.tar.gz
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> a3a17d584bae</span>
...
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 4eaa62ace8de</span>
Removing intermediate container a3a17d584bae
Step 3 : ADD *.json /app/
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 1e8ffd7e10a8</span>
Removing intermediate container 5db20e8b8ed2
Step 4 : WORKDIR /app
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 7b84b06642b1</span>
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 9c0e2287c34d</span>
Removing intermediate container 7b84b06642b1
Step 5 : RUN npm install
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 0523df6e9aac</span>
...
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 6d7327ebee30</span>
Removing intermediate container 0523df6e9aac
Step 6 : ADD . /app
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 13bdbe70c6fa</span>
Removing intermediate container 3c83d82c1d53
Step 7 : EXPOSE 3000
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 51e252173b12</span>
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 6c62eb1197e2</span>
Removing intermediate container 51e252173b12
Step 8 : VOLUME /app/log
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 4af0bb73307b</span>
<span class="hljs-meta"> ---&gt;</span><span class="bash"> 15b6190de473</span>
Removing intermediate container 4af0bb73307b
Step 9 : CMD node server.js
<span class="hljs-meta"> ---&gt;</span><span class="bash"> Running <span class="hljs-keyword">in</span> 9522c6b9bf95</span>
<span class="hljs-meta"> ---&gt;</span><span class="bash"> aaf20fb25dac</span>
Removing intermediate container 9522c6b9bf95
Successfully built aaf20fb25dac
</code></pre>
<p>L'option <code>-t</code> permet de nommer votre image docker, ce qui vous servira lorsque
vous voudrez lancer votre conteneur. Et le <code>.</code> est le repertoire où se trouve le
Dockerfile, dans notre cas le dossier courant.</p>
<p>Maintenant, vous pouvez lancer votre conteneur de cette manière :</p>
<pre><code class="language-console"><span class="hljs-meta">$</span><span class="bash"> docker run -d -p 3000:3000 -v $(<span class="hljs-built_in">pwd</span>)/<span class="hljs-built_in">log</span>:/app/<span class="hljs-built_in">log</span> fullstack-js</span>
</code></pre>
<p>Cette commande permet de lancer notre image en partageant le port et un dossier
avec votre ordinateur, si vous voulez plus de détails sur le fonctionnement du
client Docker, je vous invite à lire mon
<a href="/fr/articles/docker/">article précédent</a>.</p>
<hr />
<p>Dans cet article, vous avez pu voir comment créer votre propre Dockerfile,
maintenant vous pouvez créer des images Docker parfaitement adaptées à votre
projet, et même plus. En cherchant sur Internet, vous pourrez trouver des images
Docker pour tout et n'importe quoi, comme des images pour lancer Chrome dans un
conteneur par exemple. Pour en savoir plus, je vous redirige vers le blog de
<a href="https://blog.jessfraz.com/post/docker-containers-on-the-desktop/">Jessie Frazelle</a>.</p>
<p>Dans le prochain article, je vous parlerai de docker-compose, un outil qui
permet de lancer des applications multi-conteneurs facilement.</p>
</div><style data-emotion-rpcss="v01ydp">.rpcss-v01ydp{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin:20px auto;padding:20px;background-color:#fff;border-radius:10px;box-shadow:0 15px 15px -5px rgba(0,0,0,0.2);}@media (prefers-color-scheme:dark){.rpcss-v01ydp{background-color:#222;}}@media (max-width:540px){.rpcss-v01ydp{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-v01ydp"><style data-emotion-rpcss="ty7r4z">.rpcss-ty7r4z{font-weight:800;}</style><div class="rpcss-ty7r4z">Vous avez aimé cet article?</div><style data-emotion-rpcss="bb4ce3">.rpcss-bb4ce3{width:0px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-bb4ce3"></div><style data-emotion-rpcss="1pkr03v">.rpcss-1pkr03v{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:800;}.rpcss-1pkr03v:active{opacity:0.5;}</style><a class="rpcss-1pkr03v" href="https://www.twitter.com/intent/tweet?text=Les%20Dockerfiles%20sur%20%40PutainDeCode%20https%3A%2F%2Fputaindecode.io%2Farticles%2Fles-dockerfiles" target="_blank">Le partager sur Twitter</a></div><style data-emotion-rpcss="x4iqxe">.rpcss-x4iqxe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;text-align:center;padding:20px;}</style><div class="rpcss-x4iqxe"><style data-emotion-rpcss="gein6x">.rpcss-gein6x{font-size:20px;-webkit-text-decoration:none;text-decoration:none;color:#1E49B5;}</style><a class="rpcss-gein6x" href="/articles">← Articles</a></div><style data-emotion-rpcss="8bodgl">.rpcss-8bodgl{max-width:640px;width:100%;margin:0 auto;padding:20px 0;}</style><div class="rpcss-8bodgl" id="disqus_thread"></div></div></div></div><div class="rpcss-qx7dny"><style data-emotion-rpcss="5518eg">.rpcss-5518eg{margin-top:20px;margin-bottom:20px;background-color:#E4EBEE;border-radius:10px;padding:20px;}@media (prefers-color-scheme:dark){.rpcss-5518eg{background-color:#111;}}</style><div class="rpcss-5518eg"><style data-emotion-rpcss="1gz1i1h">.rpcss-1gz1i1h{font-size:32px;font-weight:800;margin-bottom:20px;text-align:center;}</style><div aria-level="2" class="rpcss-1gz1i1h" role="heading">Ne rien rater</div><style data-emotion-rpcss="1wbispj">.rpcss-1wbispj{font-size:18px;margin-bottom:10px;text-align:center;}</style><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur les réseaux</div><style data-emotion-rpcss="1hyoz7m">.rpcss-1hyoz7m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><div class="rpcss-1hyoz7m"><a href="https://twitter.com/PutainDeCode"><img alt="Twitter" height="48" src="/public/images/website/twitter.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://facebook.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/facebook.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://github.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/github.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://itunes.apple.com/fr/podcast/putain-de-code-!/id1185311825"><img alt="Apple Podcast" height="48" src="/public/images/website/apple-podcast.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://soundcloud.com/putaindecode"><img alt="Soundcloud" height="48" src="/public/images/website/soundcloud.svg" width="48"/></a></div><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur le chat</div><div class="rpcss-1hyoz7m"><a href="https://discord.gg/jtbGNNc"><img alt="Discord" height="48" src="/public/images/website/discord.svg" width="48"/></a></div></div></div><style data-emotion-rpcss="zs8kw7">.rpcss-zs8kw7{background-color:#222;padding:20px 0;}</style><footer class="rpcss-zs8kw7"><div class="rpcss-qx7dny"><style data-emotion-rpcss="79elbk">.rpcss-79elbk{position:relative;}</style><div class="rpcss-79elbk"><style data-emotion-rpcss="1hle0ni">.rpcss-1hle0ni{position:absolute;left:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1hle0ni" href="/api/articles/feeds/desc/feed.xml"><style data-emotion-rpcss="lvyu5j">.rpcss-lvyu5j{margin-right:10px;}</style><img class="rpcss-lvyu5j" alt="Flux RSS" height="16" src="/public/images/website/rss-feed.svg" width="16"/><style data-emotion-rpcss="um3i31">@media (max-width:400px){.rpcss-um3i31{display:none;}}</style><div class="rpcss-um3i31">Flux RSS</div></a><style data-emotion-rpcss="12cp4l7">.rpcss-12cp4l7{color:rgba(255,255,255,0.5);text-align:center;font-size:14px;}</style><div class="rpcss-12cp4l7">© 2020 Putain de code !</div><style data-emotion-rpcss="1y2rkzl">.rpcss-1y2rkzl{position:absolute;right:0;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);color:#fff;-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1y2rkzl" href="https://github.com/putaindecode/putaindecode.io">GitHub</a></div></div></footer></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"articles","v":{"k":"les-dockerfiles","v":{"_0":{"TAG":0,"_0":{"slug":"les-dockerfiles","filename":"2015-07-02-les-dockerfiles","title":"Les Dockerfiles","date":"Thu, 02 Jul 2015 00:00:00 GMT","draft":false,"meta":{"date":"2015-07-02T00:00:00.000Z","title":"Les Dockerfiles","author":"Uhsac","oldSlug":"docker/dockerfile","slug":"les-dockerfiles"},"body":"<p>Dans <a href=\"/fr/articles/docker/\">l'article précédent</a>, je vous ai présenté le\nfonctionnement de base de Docker. Mais cela vous limitait à l'usage des images\nque vous pouviez trouver sur le <a href=\"https://registry.hub.docker.com/\">Docker Hub</a>.\nAfin de vraiment pouvoir utiliser Docker au maximum, il serait appréciable de\npouvoir créer des images adaptées à nos projets et c'est là l'utilité des\nDockerfiles.</p>\n<h1>Les Dockerfiles</h1>\n<p>Les Dockerfiles sont des fichiers qui permettent de construire une image Docker\nadaptée à nos besoins, étape par étape. Rentrons dans le vif du sujet en créant\nune image permettant de lancer un projet JavaScript.</p>\n<p>Pour commencer, créez un nouveau fichier <code>Dockerfile</code> à la racine de votre\nprojet.</p>\n<p>La première chose à faire dans un Dockerfile est de définir de quelle image vous\nhéritez. Pour cet exemple, je vous propose d'utiliser une image de Debian comme\nbase (ce qui est une bonne pratique, car cette image est plutôt légère en\ncomparaison avec celle d'Ubuntu par exemple).</p>\n<pre><code>FROM debian:jessie\n</code></pre>\n<p><code>FROM</code> permet de définir notre image de base, vous pouvez l'utiliser seulement\nune fois dans un Dockerfile.</p>\n<p>Comme nous voulons créer une image pour une application JavaScript full-stack,\nnous devons commencer par installer Node.js. Pour ce faire, on va télécharger\nl'archive Node.js directement depuis le site officiel à l'aide de curl que nous\nallons aussi devoir installer.</p>\n<pre><code>RUN apt-get update \\\n&& apt-get install -y curl \\\n&& rm -rf /var/lib/apt/lists/*\n\nRUN curl -LO \"https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz\" \\\n&& tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 \\\n&& rm node-v0.12.5-linux-x64.tar.gz\n</code></pre>\n<p><code>RUN</code> permet d'exécuter une commande à l'intérieur de votre image comme si vous\nétiez devant un shell unix.</p>\n<p>La première commande nous permet d'installer curl et de nettoyer ensuite le\ngestionnaire de paquets afin que notre image soit un peu plus légère.</p>\n<p>Avec la deuxième commande, nous téléchargeons le binaire de Node.js que nous\ninstallons ensuite à sa place, et on n'oublie pas de supprimer l'archive\nensuite.</p>\n<p>Vous pouvez vous demander pourquoi j'exécute plusieurs commandes sur une même\ninstruction <code>RUN</code> ? Eh bien, cela permet simplement de limiter le nombre\nd'instructions dans votre Dockerfile ce qui rendra votre image finale plus\nlégère.</p>\n<p>Maintenant, nous allons ajouter les sources de notre projet dans l'image et\ntélécharger nos dépendances.</p>\n<pre><code>ADD package.json /app/\n\nWORKDIR /app\n\nRUN npm install\n\nADD . /app/\n</code></pre>\n<p><code>ADD</code> permet d'ajouter des fichiers locaux ou distants à l'intérieur de votre\nimage, il est le plus souvent utilisé pour importer les sources de votre projet\nou des fichiers de configuration.</p>\n<p><code>WORKDIR</code> permet de changer le répertoire courant de votre image, toutes les\ncommandes qui suivront seront exécutées à partir de ce répertoire.</p>\n<p>Avec la dernière instruction, nous ajoutons les sources de notre projet à\nl'intérieur de l'image, mais vous allez vous demander pourquoi nous ne l'avons\npas fait en même temps que l'ajout des fichiers de dépendances. Eh bien, cela\nnous permet d'économiser beaucoup de temps !</p>\n<p>Quand Docker crée une nouvelle image à partir d'un Dockerfile, il exécute chaque\ninstruction dans un conteneur, et le résultat de cette instruction est\nsauvegardé sous forme de couche. Au final, une image est un assemblage de\nplusieurs couches (une par instruction). Et donc, quand vous reconstruisez une\nimage pour la seconde fois, les instructions qui n'impliquent pas de changements\nne sont pas réexécutées, car la couche est récupérée depuis l'image précédente.\nPar contre, si l'instruction implique un changement quelconque, elle est\nréexécutée ainsi que toutes les instructions suivantes.</p>\n<p>Dans notre cas, les sources auront tendance à beaucoup changer, et donc ne pas\nretélécharger les dépendances à chaque changement dans le code est un réel gain\nde temps !</p>\n<p>Maintenant, nous allons indiquer quel port et dossier nous souhaitons partager\navec l'extérieur du conteneur.</p>\n<pre><code>EXPOSE 3000\n\nVOLUME /app/log\n</code></pre>\n<p><code>EXPOSE</code> et <code>VOLUME</code> permettent respectivement d'indiquer quel port et quel\ndossier nous souhaitons partager.</p>\n<p>Et pour finir, nous pouvons indiquer quelle instruction doit s'exécuter au\nlancement de votre conteneur grâce à l'instruction <code>CMD</code>.</p>\n<pre><code>CMD node server.js\n</code></pre>\n<p>Voici un résumé de notre Dockerfile :</p>\n<pre><code># Image de base\nFROM debian:jessie\n\n# Installation de curl avec apt-get\nRUN apt-get update \\\n&& apt-get install -y curl \\\n&& rm -rf /var/lib/apt/lists/*\n\n# Installation de Node.js à partir du site officiel\nRUN curl -LO \"https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz\" \\\n&& tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 \\\n&& rm node-v0.12.5-linux-x64.tar.gz\n\n# Ajout du fichier de dépendances package.json\nADD package.json /app/\n\n# Changement du repertoire courant\nWORKDIR /app\n\n# Installation des dépendances\nRUN npm install\n\n# Ajout des sources\nADD . /app/\n\n# On expose le port 3000\nEXPOSE 3000\n\n# On partage un dossier de log\nVOLUME /app/log\n\n# On lance le serveur quand on démarre le conteneur\nCMD node server.js\n</code></pre>\n<p>Avant de transformer ce Dockerfile en une image, vous devez créer un fichier de\nplus, le <code>.dockerignore</code>, ce fichier permet comme un <code>.gitignore</code> de ne pas\ninclure certain fichiers dans votre image Docker, et c'est très important afin\nd'éviter d'inclure les dépendances de votre projet dans votre image\n(<code>node_modules</code> dans notre cas) qui sont propres à votre système, mais pas au\nsystème du conteneur. Voici à quoi votre <code>.dockerignore</code> doit ressembler :</p>\n<pre><code>node_modules\n.git\n</code></pre>\n<p>Pour transformer ce Dockerfile en une image Docker, vous devez utiliser cette\ncommande :</p>\n<pre><code class=\"language-console\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> docker build -t fullstack-js .</span>\nSending build context to Docker daemon 4.381 MB\nSending build context to Docker daemon\nStep 0 : FROM debian:jessie\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> bf84c1d84a8f</span>\nStep 1 : RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; rm -rf /var/lib/apt/lists/*\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 93258459a279</span>\n...\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 4fffcf3749a2</span>\nRemoving intermediate container 93258459a279\nStep 2 : RUN curl -LO &quot;https://nodejs.org/dist/v0.12.5/node-v0.12.5-linux-x64.tar.gz&quot; &amp;&amp; tar -xzf node-v0.12.5-linux-x64.tar.gz -C /usr/local --strip-components=1 &amp;&amp; rm node-v0.12.5-linux-x64.tar.gz\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> a3a17d584bae</span>\n...\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 4eaa62ace8de</span>\nRemoving intermediate container a3a17d584bae\nStep 3 : ADD *.json /app/\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 1e8ffd7e10a8</span>\nRemoving intermediate container 5db20e8b8ed2\nStep 4 : WORKDIR /app\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 7b84b06642b1</span>\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 9c0e2287c34d</span>\nRemoving intermediate container 7b84b06642b1\nStep 5 : RUN npm install\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 0523df6e9aac</span>\n...\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 6d7327ebee30</span>\nRemoving intermediate container 0523df6e9aac\nStep 6 : ADD . /app\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 13bdbe70c6fa</span>\nRemoving intermediate container 3c83d82c1d53\nStep 7 : EXPOSE 3000\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 51e252173b12</span>\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 6c62eb1197e2</span>\nRemoving intermediate container 51e252173b12\nStep 8 : VOLUME /app/log\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 4af0bb73307b</span>\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> 15b6190de473</span>\nRemoving intermediate container 4af0bb73307b\nStep 9 : CMD node server.js\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> Running <span class=\"hljs-keyword\">in</span> 9522c6b9bf95</span>\n<span class=\"hljs-meta\"> ---&gt;</span><span class=\"bash\"> aaf20fb25dac</span>\nRemoving intermediate container 9522c6b9bf95\nSuccessfully built aaf20fb25dac\n</code></pre>\n<p>L'option <code>-t</code> permet de nommer votre image docker, ce qui vous servira lorsque\nvous voudrez lancer votre conteneur. Et le <code>.</code> est le repertoire où se trouve le\nDockerfile, dans notre cas le dossier courant.</p>\n<p>Maintenant, vous pouvez lancer votre conteneur de cette manière :</p>\n<pre><code class=\"language-console\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> docker run -d -p 3000:3000 -v $(<span class=\"hljs-built_in\">pwd</span>)/<span class=\"hljs-built_in\">log</span>:/app/<span class=\"hljs-built_in\">log</span> fullstack-js</span>\n</code></pre>\n<p>Cette commande permet de lancer notre image en partageant le port et un dossier\navec votre ordinateur, si vous voulez plus de détails sur le fonctionnement du\nclient Docker, je vous invite à lire mon\n<a href=\"/fr/articles/docker/\">article précédent</a>.</p>\n<hr />\n<p>Dans cet article, vous avez pu voir comment créer votre propre Dockerfile,\nmaintenant vous pouvez créer des images Docker parfaitement adaptées à votre\nprojet, et même plus. En cherchant sur Internet, vous pourrez trouver des images\nDocker pour tout et n'importe quoi, comme des images pour lancer Chrome dans un\nconteneur par exemple. Pour en savoir plus, je vous redirige vers le blog de\n<a href=\"https://blog.jessfraz.com/post/docker-containers-on-the-desktop/\">Jessie Frazelle</a>.</p>\n<p>Dans le prochain article, je vous parlerai de docker-compose, un outil qui\npermet de lancer des applications multi-conteneurs facilement.</p>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><script defer="defer" src="/public/main.3544026f09b6593da5a8.js"></script></html>